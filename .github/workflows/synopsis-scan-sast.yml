name: "Synopsys Security Scan (SAST)"

on:
  workflow_call:
    inputs:
      POLARIS_DOWNLOAD_URL:
        required: false
        type: string
        default: https://compono.polaris.synopsys.com/api/tools/v2/downloads/polaris_cli-linux64-2022.3.0.zip
      POLARIS_SERVER_URL:
        required: true
        type: string
    #   PROJECT_NAME:
    #     required: true
    #     type: string
    #   APPLICATION_NAME:
    #     required: true
    #     type: string
    #   POLICY_NAME:
    #     required: true
    #     type: string
    #   SCAN_TYPE:
    #     required: false
    #     type: string
    #     default: RAPID
    secrets:
      POLARIS_ACCESS_TOKEN:
        required: true
    
jobs:
  security:
    name: Synopsys Security Scan (SAST)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Print workflow input variables
      run: |
        echo "Secret POLARIS_ACCESS_TOKEN:  ${{ secrets.POLARIS_ACCESS_TOKEN }}"

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Execute the Synopys Detect script
      run: |
        curl -L ${{ inputs.POLARIS_DOWNLOAD_URL }} -o polaris_cli.zip
        unzip polaris_cli.zip
        export POLARIS_SERVER_URL=${{ inputs.POLARIS_SERVER_URL }}
        export POLARIS_ACCESS_TOKEN=${{ secrets.POLARIS_ACCESS_TOKEN }}
        export GIT_BRANCH=${{ github.head_ref }}
        chmod +x ./polaris_cli-linux64-2022.3.0/bin/polaris
        ./polaris_cli-linux64-2022.3.0/bin/polaris analyze -w --coverity-ignore-capture-failure	-- make build
        cat /home/runner/work/admin-ui/admin-ui/polaris.yml